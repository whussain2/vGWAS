---
title: "Double Generalized Linear Model (DGLM)"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
 <style type="text/css">
  
  
h1.title {/* Header 1 */
    font-size: 28px;
    font-family:  "Times New Roman", Times, serif;
    color: BLACK;
    #text-transform: Capitalize;
  }
  
h2 { /* Header 2 */
    font-size: 24px;
    font-family: "Times New Roman", Times, serif;
    color: Black;
    text-transform: none;
  }
h3 { /* Header 3 */
    font-size: 18px;
    font-family: "Times New Roman", Times, serif;
    color: DarkBlue;
    text-transform: none;
  }
  
h4 { /* Header 4 */
    font-size: 16px;
    font-family: "Times New Roman", Times, serif;
    color: Darkred;
    text-transform: none;
  }
  </style>

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
               cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               eval=FALSE)
opts_knit$set(width=75)
```

**Load the required libraries**
```{r}
      Packages <- c("dglm", "hglm", "gdata","readR","tidyr","ggplot",
                    "qqman", "CMplot",  "dplyr", "ggplot2", "SNPRelate",
                    "ggcorrplot", "statmod")
    lapply(Packages, library, character.only = TRUE)

```
## **Double Generalized Linear Model (DGLM)**
* Here we will be presenting the codes to show how to model variance-heterogeneity using DGLM in the context of GWAS. 
* As the analysis is computationally demanding and time consuming we performed this analysis on Holland Computing Center(HCC) server at University of Nebraska, Lincoln. 
* Here we are just providing the snippet of codes and not showing any outputs.
## Read the marker and phenotypic, and principal components

```{r, eval=FALSE}
# First we will be reading the marker data that is in rds formate and assign it to object geno
      geno<-readRDS(file="geno.rds")
# Read the cadmium data
      pheno_data<- readRDS(file="pheno_ok2_final.rds")
# Read the principal components data and assign it to object covar
    covar<-readRDS("pca_hww_299.rds")
```

### **Step 1**: Create a function for DGLM analysis 
**Description of the code:**

* First we created a function so that we can use this function to run the DGLM analysis for all the markers.
* Five arguments are passed to the function including CT (representing column for particular trait in phenotypic data file, here named as phenos), i (representing markers), geno(representing marker data file), and covar (representing PCs of marker data).
* Here we are fitting top four PCs as covariates to account for population structure.
* The basic syntax of DGLM model we are fitting  is as follows:
```
phenotype=marker_effect+ covariates (modelling mean), marker_effect(modeling dispersion/varaibility)
```
* Finally we are extracting the variables including coefficients (beta), standard error (s.e), P.mean (p-value for mean), P.disp (p-value for dispersion) and assigning them to data frame 'out'
```{r}
    my.pdglm <- function(cT,i,Phenos,geno,covar)
    {
      y <- Phenos[,cT]
      model <- dglm(y ~ geno[,i] + covar[,2] + covar[, 3] + covar[, 4] + covar[, 5],
                    ~ geno[,i], family = gaussian(link = identity))
      P.mean <- summary(model)$coef[2,4] # Extarct p values for mean part
      P.disp <- anova(model)$Adj.P[2] # Extract P values for dispersion part
      s.model <- summary(model$dispersion.fit)
      beta <- s.model$coef[2,1] # Extarct cofficients
      se <- s.model$coef[2,2] # Extract standard errors
      out <- data.frame(Beta=beta, SE = se,P.mean=P.mean, P.disp=P.disp, stringsAsFactors=FALSE) # Save all the extracted varaibales in data frame out
      return(out)
      #print(i)
    }
```
   
### **Step 2**: Use the for-loop to run function
**Description of the code:**

* First we are creating a data frame "TF" with rows equal to number of markers and columns equal to number of variables extracted from the DGLM analysis above.
* Then we are using for-loop to run the above function *my.pdglm()* for all the markers one by one and save the output in TF file.
* We are using function *try()* to continue the loop if error is encountered as some of the markers do not converge.
* Finally we are saving the output as csv file.

```{r, eval=FALSE}
    TF <- matrix(NA,nrow=dim(geno)[2],ncol=4)
    for(i in 1:dim(geno)[2])
    {
      try(
        {
          outm <- my.pdglm(cT=1,i=i,Phenos=pheno_data,geno,covar)
          TF[i,] <- as.numeric(outm)
          print(i)
        }, silent=TRUE)
    }
# save the output in folder
    write.csv(TF,file=paste('TF_',1,'CD_OKLOHOMA.csv',sep=''),
              row.names=FALSE)
```
